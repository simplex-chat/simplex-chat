# File Transfer Page Implementation Plan

## Table of Contents
1. [Context](#1-context)
2. [Executive Summary](#2-executive-summary)
3. [High-Level Design](#3-high-level-design)
4. [Detailed Implementation Plan](#4-detailed-implementation-plan)
5. [Verification](#5-verification)

---

## 1. Context

**Problem**: The website needs a `/file` page where users can upload/download files via XFTP servers, using the `@shhhum/xftp-web` npm library for client-side encryption and XFTP protocol.

**Approach**: Integrate a Vite-built JS bundle into a standard 11ty page — same pattern as `directory.html` (11ty page with `layout: layouts/main.html` + custom JS loaded at bottom). The xftp-web library handles all crypto and XFTP protocol via its public API (`encryptFileForUpload`, `uploadFile`, `downloadFile`).

**Routing**: `/file/` (no hash) = upload mode; `/file/#<uri>` = download mode.

---

## 2. Executive Summary

| Action | Files |
|--------|-------|
| **Create** | 5 files in `website/file-src/` (TS source), 1 `website/src/file.html` (11ty page), 1 `website/vite.file.config.ts`, 1 `website/file-src/servers.json` |
| **Modify** | `website/package.json`, `website/.eleventy.js` (1 line each: passthrough + supportedRoutes), `website/src/_includes/navbar.html` (nav link + lang-selector exclusion), `website/langs/en.json` (1 translation key), `.gitignore` (1 line) |
| **Generated** | `website/src/file-assets/` (Vite build output, gitignored) |
| **Haskell** | None |

---

## 3. High-Level Design

### Architecture

```
website/
├── file-src/                    # NEW: Vite source (TypeScript)
│   ├── main.ts                  # Entry: hash routing
│   ├── upload.ts                # Upload UI
│   ├── download.ts              # Download UI
│   ├── progress.ts              # Canvas progress ring
│   ├── servers.ts               # Server list (__XFTP_SERVERS__ define)
│   └── servers.json             # Preset XFTP server addresses (SimpleX + Flux)
├── vite.file.config.ts          # NEW: Vite config
├── src/
│   ├── file.html                # NEW: 11ty page (layout: main.html)
│   └── file-assets/             # GENERATED by Vite (gitignored)
│       └── file.js              # Bundled ES module
```

### Build Pipeline (modified `npm run build`)

```
build:js → build:file → build:eleventy → build:tailwind
                ↑
    Vite bundles file-src/*.ts → src/file-assets/
    (11ty then copies src/file-assets/ → _site/file-assets/)
```

### Data Flow

**Upload**: File → `encryptFileForUpload(bytes, name)` → `uploadFile(agent, servers, encrypted)` → `result.uri` → share link with `#<uri>`
**Download**: Hash → `decodeDescriptionURI(hash)` → `downloadFile(agent, fd)` → `{header, content}` → browser save

---

## 4. Detailed Implementation Plan

### Step 1: Install dependencies & update build scripts

**Modify**: `website/package.json`

```diff
 "scripts": {
+  "build:file": "vite build --config vite.file.config.ts",
-  "build": "npm run build:js && npm run build:eleventy && npm run build:tailwind",
+  "build": "npm run build:js && npm run build:file && npm run build:eleventy && npm run build:tailwind",
 },
 "devDependencies": {
+  "vite": "^6.0.0",
 },
 "dependencies": {
+  "@shhhum/xftp-web": "*",
 }
```

### Step 2: Create Vite config

**New file**: `website/vite.file.config.ts`

Key settings:
- `root: 'file-src'`, `base: '/file-assets/'`
- `build.outDir: resolve(__dirname, 'src/file-assets')` (absolute path)
- `build.emptyOutDir: true`, `target: 'esnext'`
- `build.rollupOptions.input: resolve(__dirname, 'file-src/main.ts')` (absolute path)
- `output.entryFileNames: 'file.js'`
- `import servers from './file-src/servers.json'` at top of config (ES import — NOT `readFileSync` which resolves relative to CWD)
- `define.__XFTP_SERVERS__: JSON.stringify([...servers.simplex, ...servers.flux])`

### Step 3: Create TypeScript source files in `file-src/`

All imports from `@shhhum/xftp-web` (the public API described in the library README).

| File | Purpose |
|------|---------|
| `servers.json` | Preset XFTP server addresses for SimpleX and Flux operators (copy from `xftp-web/web/servers.json`) |
| `servers.ts` | Parses `__XFTP_SERVERS__` (injected by Vite define) with `parseXFTPServer()` into `XFTPServer[]` |
| `progress.ts` | Canvas progress ring (adapted from `xftp-web/web/progress.ts`, dark mode color adaptation) |
| `upload.ts` | Upload UI — uses `encryptFileForUpload()` + `uploadFile()`, share link from `result.uri` |
| `download.ts` | Download UI — uses `decodeDescriptionURI()` + `downloadFile()` → triggers browser save |
| `main.ts` | Entry: hash routing (`#` → download, else → upload), targets `#file-app` |

**API usage**:

*Preset servers*: `servers.json` defines XFTP server addresses for two operators — SimpleX and Flux. Vite injects them at build time via `define.__XFTP_SERVERS__`. `servers.ts` parses them with `parseXFTPServer()` into `XFTPServer[]`.

*Upload flow*: `encryptFileForUpload(fileBytes, fileName)` encrypts in-memory, returning `EncryptedFileInfo` (encData, digest, key, nonce, chunkSizes). `uploadFile(agent, servers, encrypted, {onProgress})` distributes chunks across servers randomly. `result.uri` is the pre-encoded share URI (handles redirect compression internally).

*Download flow*: `decodeDescriptionURI(hash)` parses the URI into a `FileDescription`. `downloadFile(agent, fd, onProgress)` fetches and decrypts all chunks, returning `{header, content}`. `header.fileName` provides the original filename for the browser save.

*Error handling*: `XFTPPermanentError` (file expired/deleted/blocked) hides the retry button. Other errors (`XFTPRetriableError`) show retry. `isRetriable(err)` available for programmatic check.

### Step 4: Create 11ty page

**New file**: `website/src/file.html`

Pattern: identical to `directory.html` structure.

```
---
layout: layouts/main.html
title: "SimpleX File Transfer"
description: "Send files securely with end-to-end encryption"
templateEngineOverride: njk
active_file: true
---

<style>
  /* Drop zone, progress ring, share link, security note styles */
  /* ~60 lines of custom CSS (dark mode via .dark prefix) */
</style>

<section class="py-10 px-5 mt-[66px] dark:text-white">
  <div class="container" style="max-width: 520px;">
    <h1 class="text-[38px] text-center font-bold text-active-blue mb-8">
      SimpleX File Transfer
    </h1>
    <div id="file-app"><noscript>JavaScript is required.</noscript></div>
  </div>
</section>

<script type="module" src="/file-assets/file.js"></script>
```

### Step 5: Add navbar link

**Modify**: `website/src/_includes/navbar.html`

Insert after Directory link (line 28), before the `<hr>` before Guide:
```html
<hr>
<li class="nav-link {% if active_file %}active{% endif %}">
    <a href="/file/">
        <span class="nav-link-text">{{ "file" | i18n({}, lang) | safe }}</span>
    </a>
</li>
```

Also add `'file' not in page.url` to the language-selector exclusion on line 137.

### Step 6: Add translation key

**Modify**: `website/langs/en.json` — add `"file": "File"` (after `"directory"` entry).

### Step 7: Update .eleventy.js

**Modify**: `website/.eleventy.js`

1. Add `"file"` to `supportedRoutes` array (line 56):
```js
const supportedRoutes = ["blog", "contact", "invitation", "messaging", "docs", "fdroid", "file", ""]
```

2. Add passthrough (after line 297, near other passthrough copies):
```js
ty.addPassthroughCopy("src/file-assets")
```

### Step 8: Gitignore build artifacts

Add to root `.gitignore` (at `.gitignore`, in the website section after line 58):
```
website/src/file-assets/
```

---

## 5. Verification

### Build
```bash
cd website
npm install
npm run build:file    # Vite → src/file-assets/
npm run build         # Full build
ls _site/file/index.html _site/file-assets/file.js  # Both exist
```

### Manual test
```bash
npm run start         # 11ty dev (note: file-assets must be pre-built)
# Visit localhost:8080/file/
# 1. Verify navbar shows "File" link with active state
# 2. Upload a small file → get share link
# 3. Open share link → download works
# 4. Toggle dark mode → UI adapts
# 5. Check mobile responsive layout
```

### Website build check
```bash
# Confirm no regressions in existing pages
ls _site/index.html _site/directory/index.html _site/blog/index.html
```
